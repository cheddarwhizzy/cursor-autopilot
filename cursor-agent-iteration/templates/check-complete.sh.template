#!/usr/bin/env bash
# Check if all tasks are completed

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

resolve_tasks_file() {
    if [[ -n "${TASKS_FILE:-}" ]]; then echo "$TASKS_FILE"; return 0; fi
    if [[ -f "tasks.md" ]]; then echo "tasks.md"; return 0; fi
    if [[ -f "../tasks.md" ]]; then echo "../tasks.md"; return 0; fi
    return 1
}

if ! TASKS_FILE_RESOLVED=$(resolve_tasks_file); then
    echo -e "${RED}‚ùå tasks.md not found in current or parent directory${NC}"
    echo -e "${YELLOW}Tip:${NC} Run inside your repo with tasks.md or set TASKS_FILE"
    exit 1
fi

# Count tasks by headers; status by emoji on the header
TOTAL_TASKS=$(grep -E -c '^### Task:' "$TASKS_FILE_RESOLVED" 2>/dev/null || echo "0")
COMPLETED_TASKS=$(grep -E -c '^### Task: .*‚úÖ' "$TASKS_FILE_RESOLVED" 2>/dev/null || echo "0")

# Ensure we have valid numbers for arithmetic
if [[ ! "$TOTAL_TASKS" =~ ^[0-9]+$ ]]; then
    TOTAL_TASKS=0
fi
if [[ ! "$COMPLETED_TASKS" =~ ^[0-9]+$ ]]; then
    COMPLETED_TASKS=0
fi

REMAINING_TASKS=$((TOTAL_TASKS - COMPLETED_TASKS))

echo -e "${CYAN}üìä Task Status:${NC}"
echo -e "   Total tasks: ${YELLOW}$TOTAL_TASKS${NC}"
echo -e "   Completed: ${GREEN}$COMPLETED_TASKS${NC}"
echo -e "   Remaining: ${RED}$REMAINING_TASKS${NC}"

if [[ $REMAINING_TASKS -eq 0 && $TOTAL_TASKS -gt 0 ]]; then
    echo -e "${GREEN}‚úÖ All tasks completed!${NC}"
    echo -e "${CYAN}üéâ Project iteration cycle is complete!${NC}"
    
    # Update progress.md with completion
    if [[ -f "progress.md" ]]; then
        echo "" >> progress.md
        echo "## üéâ All Tasks Completed" >> progress.md
        echo "- **Date**: $(date)" >> progress.md
        echo "- **Status**: All $TOTAL_TASKS tasks completed successfully" >> progress.md
        echo "- **Next Steps**: Project ready for next phase or new feature development" >> progress.md
    fi
    
    # Update CHANGELOG.md with completion
    if [[ -f "CHANGELOG.md" ]]; then
        # Add completion entry to CHANGELOG
        sed -i.tmp '/## \[Unreleased\]/a\
\
### Completed\
- All iteration tasks completed successfully\
- Project ready for next development phase' CHANGELOG.md
        rm -f CHANGELOG.md.tmp
    fi
    
    exit 0
else
    echo -e "${YELLOW}‚è≥ Tasks remaining. Continue with:${NC}"
    echo -e "   ${CYAN}make iterate${NC}       # Run next single task"
    echo -e "   ${CYAN}make iterate-loop${NC}  # Run continuously until all tasks complete"
    exit 1
fi
