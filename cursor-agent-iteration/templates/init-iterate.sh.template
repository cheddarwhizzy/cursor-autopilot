#!/usr/bin/env bash
set -euo pipefail

PROMPT_FILE="./prompts/initialize-iteration-universal.md"
TARGET_DIR="${1:-.}"
MODEL="${MODEL:-gpt-4o-mini}"   # override with: MODEL="gpt-4o" ./scripts/init-iterate.sh

if ! command -v cursor-agent >/dev/null 2>&1; then
  echo "Installing cursor-agent..."
  curl https://cursor.com/install -fsS | bash
  echo "Note: You may need to add ~/.local/bin to PATH and restart your shell"
  export PATH="$HOME/.local/bin:$PATH"
fi

if [[ ! -f "$PROMPT_FILE" ]]; then
  echo "âŒ Missing prompt file: $PROMPT_FILE"
  exit 1
fi

echo "âš™ï¸  Analyzing codebase and generating prompts/iterate.md (universal detection)"
echo "ğŸ“‹ This will create control files: architecture.md, progress.md, decisions.md, test_plan.md, qa_checklist.md, CHANGELOG.md, context.md"
cursor-agent --print --force --model "$MODEL" "$(cat "$PROMPT_FILE")"

echo "âœ… Created/updated: prompts/iterate.md"
echo "ğŸ“‹ Control files populated with codebase analysis"
echo "â¡ï¸  Next steps:"
echo "   make add-feature  # Add new feature/requirements to architect and create tasks"
echo "   make task-status  # Show current task status (will be empty until features added)"
